<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="keywords" content="c++, python, java, html5, css3, 编程, 学生编程，个人博客，大学生博客"><meta name="description" content="目前是大二学生，没有可以拿出来说道的东西，慢慢学，慢慢走"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>轻松，高效，正确的写出一个爬虫？看这一篇就够了！ | 落阳的博客</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><script src="/js/pace.min.js"></script><meta name="generator" content="Hexo 4.2.0"></head></html><body><div id="app"><main class="content"><section class="outer"><article id="post-轻松，高效，正确的写出一个爬虫？看这一篇就够了！踩过无数坑后总结的爬虫编写流程" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal><div class="article-inner"><header class="article-header"><h1 class="article-title sea-center" style="border-left:0" itemprop="name">轻松，高效，正确的写出一个爬虫？看这一篇就够了！</h1></header><div class="article-meta"><a href="/%E8%BD%BB%E6%9D%BE%EF%BC%8C%E9%AB%98%E6%95%88%EF%BC%8C%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%86%99%E5%87%BA%E4%B8%80%E4%B8%AA%E7%88%AC%E8%99%AB%EF%BC%9F%E7%9C%8B%E8%BF%99%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F%E4%BA%86%EF%BC%81%E8%B8%A9%E8%BF%87%E6%97%A0%E6%95%B0%E5%9D%91%E5%90%8E%E6%80%BB%E7%BB%93%E7%9A%84%E7%88%AC%E8%99%AB%E7%BC%96%E5%86%99%E6%B5%81%E7%A8%8B.html" class="article-date"><time datetime="2020-04-28T11:51:10.000Z" itemprop="datePublished">2020-04-28</time></a></div><div class="tocbot"></div><div class="article-entry" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在前面一段时间，我一直在研究python爬虫领域的知识，并且接了一些爬虫的单子来训练自己，在应对客户的各种奇葩要求和处理爬虫中遇到的各种奇怪情况之后，我也慢慢摸索出了一套写爬虫的基本流程思路，在这里分享给大家。作为爬虫学习阶段的收尾了。我要向更高方向进发啦！</p><p><strong>注：本篇文章讲的是流程而不提供问题的具体解决办法，具体问题还请具体摸索解决。这里默认大家已经有了一定的爬虫基础，但是对完整的网页分析和爬取流程依旧有困惑。</strong></p><p><strong>二注：本篇文章不考虑selenium的使用，因为想用selenium来爬取较多的数据的话不太现实，速度太慢了。</strong></p><a id="more"></a><hr><h1 id="环境（工具）"><a href="#环境（工具）" class="headerlink" title="环境（工具）"></a>环境（工具）</h1><ul><li><p><strong>谷歌浏览器（或者火狐浏览器）</strong></p></li><li><p><strong>mitmproxy (通过pip工具下载）</strong></p></li><li><p><strong>pycharm（或者vscode）</strong></p></li><li><p><strong>python3.7及以上</strong></p><hr></li></ul><p><strong>接下来就是爬虫编写的完整流程和中途会碰到的问题分析。</strong></p><h1 id="1-网页初步分析"><a href="#1-网页初步分析" class="headerlink" title="1.网页初步分析"></a>1.网页初步分析</h1><h3 id="1-网页类型"><a href="#1-网页类型" class="headerlink" title="1.网页类型"></a>1.网页类型</h3><p><strong>先悄悄告诉大家，如果大家需要爬取某个网页的话，先去找找这个网页有没有移动版本也就是手机端的页面，通常来说手机端的页面会简单很多。</strong></p><p>网页类型可大致分为<code>单页类型</code>， <code>瀑布加载类型</code>，<code>列表翻页类型</code>，<code>混合类型</code>，单页类型如下所示：</p><p><img src="https://upload-images.jianshu.io/upload_images/20361402-c2621ae3f5fd3458?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="单页类型"><br><strong>一般这种网页也叫做信息详情页，简称详情页。没有列表出现，有的只是具体信息的排版。信息详情页可能使用ajax异步加载，也可能直接使用静态页面放在html文件当中呈现。</strong></p><p>接下来看看瀑布加载类型：<br><img src="https://upload-images.jianshu.io/upload_images/20361402-0629f44e1e6fba19?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="瀑布加载类型"><br><strong>瀑布加载类型，往往会用在图片网站当中，同时，它也经常和列表翻页类型一起出现，判断瀑布加载类型网页的最简单办法就是向下滑动滚动条，若到底之后又有新的内容展现出来同时滑动条往上面自动移动了，那基本确定是瀑布加载类型。瀑布加载类型一般采用ajax异步加载请求方式实现。</strong></p><p>然后是列表翻页类型：<br><img src="https://upload-images.jianshu.io/upload_images/20361402-0dc5e943dc8e2f72?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="在这里插入图片描述"><br><strong>这种页面是爬虫中最常见的一类页面，其标志性在于其页面中往往有许多个相同结构的信息条，并且在底部带有翻页功能，这一类信息往往都是ajax异步加载，很少有直接放在html静态页面里面的。如果我们需要获取的信息从列表页就可以直接获取，那事情就变得非常简单，直接翻页获取每一页的每个列表信息即可，若是需要更详细的信息，则需要通过列表页获取详情页链接，然后进入详情页抓取信息。</strong></p><p>最后是混合页面：<br><img src="https://upload-images.jianshu.io/upload_images/20361402-b8a6b6f2f2cae693?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="混合页面"></p><p><strong>混合类型是指一个页面中分了不同的区，不同的区是不同类型的页面。常见于需要爬取评论的情况。比如上图中，是一个淘宝商品的详情页，对既需要商品详情信息又需要评论信息的人来说。这就是一个混合类型页面，上半区是详情页也就是单页类型，而评论部分则是列表翻页类型。</strong></p><h3 id="2-信息来源判断"><a href="#2-信息来源判断" class="headerlink" title="2.信息来源判断"></a>2.信息来源判断</h3><p>网页类型判断出来之后，还需要更进一步判断，分析页面信息的来源：<br>信息来源就两种，<strong>静态页面 或者 Ajax异步加载</strong><br>判断信息来源的方法也很简单：</p><p><strong>F12打开页面审查，然后从网页中复制一部分需要抓取的关键信息利用F12中的搜索功能进行搜索（在审查界面中ctrl+f打开），一般情况下都能找到。然后根据信息所在的位置确定是html静态页面加载还是ajax异步加载。</strong><br><img src="https://upload-images.jianshu.io/upload_images/20361402-0cbfeccfaaa4496b?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="审查元素搜索功能"></p><p><strong>这里额外说明一下，如果搜索不到怎么办。</strong></p><p>有两种情况：</p><p><strong>一种是出现了css字体加密，这种情况请自行解决css字体加密的问题，本文不作介绍。</strong></p><p><strong>第二种是文字信息存放在异步加载的页面中，同时是处于一种被编码的状态，也就是unicode编码的状态，所以搜索不到，这种情况属于异步加载，可以通过抓包打断点的方式锁定位置，同时也请自行解码处理。</strong></p><p><strong>页面类型和信息来源分析完毕之后，我们进入到分析url和请求头的过程中</strong></p><hr><h1 id="2-请求url优化和请求头分析处理"><a href="#2-请求url优化和请求头分析处理" class="headerlink" title="2.请求url优化和请求头分析处理"></a>2.请求url优化和请求头分析处理</h1><h3 id="1-url优化"><a href="#1-url优化" class="headerlink" title="1.url优化"></a>1.url优化</h3><p>我们请求的url往往是类似这样的<br><code>https://xxxxxx.xxxx.com/xxx.html?a=xxx&amp;b=xxx&amp;c=xxx</code><br>在html后面加个<code>?</code>然后带上一大堆<code>a=xx</code>类似的参数并用<code>&amp;</code>分割开来。<br><strong>这些参数有些是必要的，但是很多都是无用的，只会降低我们请求网页的速度（在大规模爬取中这个很重要）。</strong></p><p><strong>所以这里需要用中间人工具<code>mitmproxy</code>来筛选去除那些无用的参数，以提高我们的请求速度。</strong></p><h3 id="2-请求头分析处理"><a href="#2-请求头分析处理" class="headerlink" title="2.请求头分析处理"></a>2.请求头分析处理</h3><p>这一步是重灾区，千千万万个爬虫在这里倒下了，因为，这一步可能会碰到一个非常难的问题：<strong>js参数加密</strong>。</p><p>首先，放轻松，js参数加密的网站数量还是不太多，我们按照正常的流程来进行。</p><p>同样的，这一步需要用到<code>mitmproxy</code>中间人工具。 看看下面这看花眼的request请求头<br><img src="https://upload-images.jianshu.io/upload_images/20361402-a3b03d94ceab355b?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="请求头"><br><strong>以我的经验，我可以负责任的告诉你，这些参数百分之九十以上都是不必要的！</strong></p><p>一般，对于反爬不严的网站，我们的请求头就只需要下面这几个：<br><code>accept</code>, <code>accept-encoding</code>, <code>accept-language</code>, <code>user-agent</code></p><p>这几个参数只要放到请求头中，可以解决半数以上的网站</p><p><strong>利用中间人工具首先判断这样是否可行，如果不可行，我们再一点点补上参数。</strong></p><p>其中，如果网站需要登陆的话，那么cookies中需要保留其中一部分记录了登陆信息的值，至于是哪几个需要具体情况具体分析。</p><p>js加密的参数一般来说有三种存在形式</p><p><strong>1. 放置在get请求中的cookies中。</strong><br><strong>2. 放置在get请求的QueryString参数中。</strong><br><strong>3. 放置在post请求的post参数当中。</strong></p><p><strong>这里大致说一下，碰到js加密参数的一般处理方法。</strong></p><p>第一点也是最重要的一点：<strong>去搜索引擎搜索</strong>——对于js加密参数这种东西，如果网上有现成的，就千万别傻傻的去自己做，找现成的，哪怕是过时了，对于你之后分析也会有很大的参考作用。</p><p>第二就是，<strong>利用浏览器的调试功能，打断点，逆向追踪到这个加密参数开始生成的地方，中途的每一步都打上断点。</strong> 最后逆向分析完成之后，再一步步返回去，把中途的js代码扣下来，放到一个文件中去，然后利用python的运行js的库（有三种，可自行上网搜索）运行它的js代码生成加密参数。</p><p><strong>js加密这一部分没有一劳永逸的办法，除非你用的是骇客技术，直接走后门，肛就完事了，否则的话都是需要具体情况具体分析的。</strong></p><p><strong>url和请求头参数分析完毕之后，就开始进行页面结构的分析和数据抓取</strong></p><hr><h1 id="3-页面元素分析和数据抓取"><a href="#3-页面元素分析和数据抓取" class="headerlink" title="3.页面元素分析和数据抓取"></a>3.页面元素分析和数据抓取</h1><h3 id="1-静态页面数据抓取"><a href="#1-静态页面数据抓取" class="headerlink" title="1.静态页面数据抓取"></a>1.静态页面数据抓取</h3><p>静态页面的数据抓取没什么好说的，很简单。</p><p><strong>一般来说用来提取网页结构的工具有两种： <code>xpath</code>和<code>Beautifulsoup</code>，个人更加喜欢<code>xpath</code>一点，简单明了上手快。（好吧就是我懒）</strong></p><h3 id="2-ajax异步请求数据抓取"><a href="#2-ajax异步请求数据抓取" class="headerlink" title="2.ajax异步请求数据抓取"></a>2.ajax异步请求数据抓取</h3><p>这部分的变化稍微有点多。</p><p>首先到这一步需要保证已经对异步请求的接口分析完毕，能正确拿到ajax异步数据了。</p><p>然后ajax异步数据返回的格式大致有两种：</p><p><strong>第一种就是返回json格式数据，这个是比较好抓取的，直接用json库loads一下然后提取数据就ok了。</strong></p><p><strong>第二种是返回html结构数据，我们拿到这部分数据之后，还往往需要利用上述两个工具之一对这部分数据进行提取，拿到需要的数据。</strong></p><p>如果你们还发现请求到了另外结构的数据，可以发给我看一下，我也对这个挺好奇的。</p><p><strong>页面结构和数据分析完毕之后，咱就准备真正开始跑爬虫啦，还有最后一步</strong></p><hr><h1 id="4-请求头和代理的使用"><a href="#4-请求头和代理的使用" class="headerlink" title="4.请求头和代理的使用"></a>4.请求头和代理的使用</h1><h3 id="1-随机请求头"><a href="#1-随机请求头" class="headerlink" title="1.随机请求头"></a>1.随机请求头</h3><p><strong>据说在每次请求更换不同的请求头能在一定程度上降低爬虫被抓住的概率（理论上来说有一定道理，但是实际有没有用我也没有具体的数据，无法给大家一个明确的答案）</strong></p><p>如果有需要可自行在搜索引擎中查找ua请求头大全。</p><p><strong>这里有一个坑需要提醒大家（我踩过，摔的老惨了），如果你爬取的是pc端的网页，那么你的请求头里面最好不要有移动端ua头，这可能会让网页变成移动端的样式但是你依旧认为它是pc端，导致数据抓取失败。</strong></p><p>移动端同理。</p><h3 id="2-使用代理ip"><a href="#2-使用代理ip" class="headerlink" title="2.使用代理ip"></a>2.使用代理ip</h3><p>这一步视情况而定，使用的条件如下：</p><p><strong>1. 爬取的页面非常多，上万甚至上十万个页面。</strong><br><strong>2. 时间所迫，需要爬取的速度很快。</strong><br><strong>3. 网站反爬严格，频率控制的很低。</strong></p><p><strong>以上条件只要满足一个就可以考虑使用代理了。</strong></p><p>这里我需要打一下自己的脸，之前我发过一篇文章<code>一篇文章让你拥有用不完的ip代理</code>，确实我没骗你们哈。ip代理确实用不完。</p><p>但是免费ip终究是免费ip，数量再多也无法弥补质量的差距，质量实在太差了，严重影响爬取速度，不适合用在正式，有一定规模的爬虫当中。</p><p><strong>所以这里如果有需要的话，可以去购买付费代理。质量是真的好，并且提供小时包和日包，大家自行搜索，我就不打广告了。</strong></p><hr><h1 id="5-爬取"><a href="#5-爬取" class="headerlink" title="5.爬取"></a>5.爬取</h1><p><strong>以上就是编写一个爬虫的流程了，当然，即使经过每一步的认真分析，在真正爬取的时候依然会碰到一些奇怪的问题。</strong></p><p><strong>比如由服务器端引起的问题，比如网页结构的稀有变化，比如碰到302重定向问题。</strong></p><p>这些问题都是需要在碰到的时候具体分析的，我在这里提个建议——<strong>多使用try语句，在出错之后把出错的网址和错误都打印出来，然后手动打开这个网址，根据错误来分析，这样可以有效的减少解决错误所用的时间。</strong></p><p>如果爬取的数据量很大的话，不太建议手动多进程多线程，很难把握这个度。<strong>建议使用scrapy框架，这个框架是异步的，亲测可以把我i5的cpu跑满，异步请求非常快，而且资源调度很合理。</strong></p><p><strong>以上流程同样适用于使用scrapy框架的朋友。</strong></p><hr><h1 id="6-后记"><a href="#6-后记" class="headerlink" title="6.后记"></a>6.后记</h1><p><strong>爬虫部分到这里我就告一段落了，对于这段时间的爬虫学习和经历，我还是有一些感想。</strong></p><p>相比较于python其它的应用，比如大数据，机器学习，数据分析，人工智能来说，爬虫是一个上限比较低的技术，可能更多的是处于一种出卖劳动力的状态。（别跟我说搜素引擎，那已经不仅是爬虫了）</p><p>我这里说的是指只爬取数据，不对数据进行整理和分析。因为我个人在接单的时候，往往爬取数据是第一步，之后就是数据分析，建立模型预测等等。后面两个才是重头。</p><p>另外就是，对掌握了爬虫技术并且接单应用的人来说，其实心里还是有点顾忌，因为爬虫这项技术是处在触犯法律的边缘上了，所以在这里跟大家说一下：不要爬取不能爬的数据，比如私人信息，个人电话号码，家庭住址等等数据，这些不要去触碰，要有自己的判断力。</p><p>我和我的一位老师说过这些事情，老师的一句话让我警醒了：<strong>把接单当作学习成果的阶段性检验和巩固，而不是当作目标。</strong></p><p><strong>所以这里我也把这句话送给和我状态差不多或者正在朝着这个方向去的朋友们。</strong></p><p><strong>我是落阳，谢谢你的到访！</strong></p><p><strong>如果喜欢的话可以关注我的个人公众号【程序小员】</strong></p><div id="reward-btn">打赏</div></div><footer class="article-footer"><a data-url="http://hsluoyang.club/%E8%BD%BB%E6%9D%BE%EF%BC%8C%E9%AB%98%E6%95%88%EF%BC%8C%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%86%99%E5%87%BA%E4%B8%80%E4%B8%AA%E7%88%AC%E8%99%AB%EF%BC%9F%E7%9C%8B%E8%BF%99%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F%E4%BA%86%EF%BC%81%E8%B8%A9%E8%BF%87%E6%97%A0%E6%95%B0%E5%9D%91%E5%90%8E%E6%80%BB%E7%BB%93%E7%9A%84%E7%88%AC%E8%99%AB%E7%BC%96%E5%86%99%E6%B5%81%E7%A8%8B.html" data-id="ck9jur3320000t8vohrrk3a1a" class="article-share-link">分享</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li></ul></footer></div><nav class="article-nav"><a href="/python%E7%88%AC%E8%99%AB-%E5%B8%A6%E4%BD%A0%E6%B8%B8%E8%A7%88%E5%BE%AE%E5%8D%9A%E5%8D%9A%E4%B8%BB%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F.html" class="article-nav-link"><strong class="article-nav-caption">下一篇</strong><div class="article-nav-title">python爬虫:带你游览微博博主的前世今生</div></a></nav><div id="vcomments-box"><div id="vcomments"></div></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script><script>new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: '5WSaK6bUDnRLhgbQjaL5R9Tq-gzGzoHsz',
        app_key: '7x0vYeAw0aRYU5SjaFugWDxh',
        path: window.location.pathname,
        avatar: 'mp',
        placeholder: '给我的文章加点评论吧~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }</script><style>#vcomments-box{padding:5px 30px}@media screen and (max-width:800px){#vcomments-box{padding:5px 0}}#vcomments-box #vcomments{background-color:#fff}.v .vlist .vcard .vh{padding-right:20px}.v .vlist .vcard{padding-left:10px}</style></article></section><footer class="footer"><div class="outer"><ul class="list-inline"><li>&copy; 2019-2020 落阳</li><li><a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a> by shenyu</li></ul><ul class="list-inline"><li><ul class="list-inline"><li>PV:<span id="busuanzi_value_page_pv"></span></li><li>UV:<span id="busuanzi_value_site_uv"></span></li></ul></li><li></li></ul></div></footer><div class="to_top"><div class="totop" id="totop"><i class="ri-arrow-up-line"></i></div></div></main><aside class="sidebar"><button class="navbar-toggle"></button><nav class="navbar"><div class="logo"><a href="/"><img src="/images/touxiang.png" alt="落阳的博客"></a></div><ul class="nav nav-main"><li class="nav-item"><a class="nav-item-link" href="/">主页</a></li><li class="nav-item"><a class="nav-item-link" href="/archives">目录</a></li><li class="nav-item"><a class="nav-item-link" href="/tags">标签</a></li></ul></nav><nav class="navbar navbar-bottom"><ul class="nav"><li class="nav-item"><a class="nav-item-link nav-item-search" title="搜索"><i class="ri-search-line"></i> </a><a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed"><i class="ri-rss-line"></i></a></li></ul></nav><div class="search-form-wrap"><div class="local-search local-search-plugin"><input type="search" id="local-search-input" class="local-search-input" placeholder="Search..."><div id="local-search-result" class="local-search-result"></div></div></div></aside><div id="mask"></div><div id="reward"><span class="close"><i class="ri-close-line"></i></span><p class="reward-p"><i class="ri-cup-line"></i>谢谢你请我吃糖果~</p><div class="reward-box"><div class="reward-item"><img class="reward-img" src="/images/alipay.png"> <span class="reward-type">支付宝</span></div><div class="reward-item"><img class="reward-img" src="/images/weixin.png"> <span class="reward-type">微信</span></div></div></div><script src="/js/jquery-2.0.3.min.js"></script><script src="/js/jquery.justifiedGallery.min.js"></script><script src="/js/lazyload.min.js"></script><script src="/js/busuanzi-2.3.pure.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/tocbot.min.js"></script><script>tocbot.init({tocSelector:".tocbot",contentSelector:".article-entry",headingSelector:"h1, h2, h3, h4, h5, h6",hasInnerContainers:!0,scrollSmooth:!0,positionFixedSelector:".tocbot",positionFixedClass:"is-position-fixed",fixedSidebarOffset:"auto"})</script><script>var ayerConfig={mathjax:!1}</script><script src="/js/ayer.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css"><script type="text/javascript" src="https://js.users.51.la/20544303.js"></script></div></body>